<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>-기독교인을 위한 AI-</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="stack">
      <div class="card">
          <h3>설정</h3>

          <label>연령대</label>
          <select id="age">
            <option value="">선택</option>
            <option>10대</option><option>20대</option><option>30대</option>
            <option>40대</option><option>50대</option>
          </select>

          <!-- 1) 직접 질문을 위로 이동 -->
          <label style="margin-top:12px">직접 질문</label>
          <input id="custom" placeholder="자유 질문 입력">

          <!-- 2) 프리셋 체크박스는 한 칸 안에 표시 -->
          <label style="margin-top:12px">추천 질문</label>
          <div id="qbox" class="qbox"><div class="muted">연령대를 먼저 선택</div></div>

          <div class="muted" id="personaInfo" style="margin-top:6px"></div>
          <div class="actions" style="margin-top:10px">
            <button id="ask">질문하기</button>
            <button id="clear">히스토리 초기화</button>
          </div>
          <div class="muted" style="margin-top:8px" id="templateInfo"></div>
      </div>
      <div class="card">
        <h3>대화</h3>
        <div id="chat" class="chat"></div>
      </div>
    </div>
  </div>

<script>
  const APPS_SCRIPT_URL='https://script.google.com/macros/s/AKfycbw7jqdXJlt9h04PGOsQLT0IwkDLdYwlL2tJuIJKqlYajH8V90xcfBt3uUfkHbQg1k1Qww/exec';

  const ageEl=document.getElementById('age');
  const qbox=document.getElementById('qbox');
  const customEl=document.getElementById('custom');
  const askBtn=document.getElementById('ask');
  const clearBtn=document.getElementById('clear');
  const chatEl=document.getElementById('chat');
  const personaInfo=document.getElementById('personaInfo');
  const templateInfo=document.getElementById('templateInfo');

  let state={ age:'', persona:null, background:'', questions:[], history:[], template:null };
  const key=()=>`qa-history:${state.age}`;

  ageEl.addEventListener('change', loadMeta);

  async function loadMeta(){
    state.age=ageEl.value; if(!state.age){ qbox.innerHTML='<div class="muted">연령대를 먼저 선택</div>'; return; }
    try{
      const res=await fetch(`${APPS_SCRIPT_URL}?age=${encodeURIComponent(state.age)}`);
      const data=await res.json();
      state.persona=data.persona||null; state.background=data.background||''; state.template=data.template||null;
      state.questions=Array.isArray(data.questions)?data.questions:[];
      renderCheckboxes(state.questions);
      personaInfo.innerHTML = state.persona && state.persona.SystemPrompt ? `<span class="pill">페르소나: ${state.persona.PersonaName||''}</span>`: '';
      if(state.template){ templateInfo.textContent = `템플릿: ${state.template.header} / 섹션: ${state.template.sections.join(', ')} / 섹션당 ${state.template.bullets}개`; }
      loadHistory();
    }catch(e){
      renderMsg(`[오류] 메타 로드 실패: ${e.message}`,'assistant');
    }
  }

  function getCheckedQuestions(){ return [...qbox.querySelectorAll('input[type=checkbox]:checked')].map(cb=>cb.value); }
  function loadHistory(){ chatEl.innerHTML=''; state.history = JSON.parse(localStorage.getItem(key())||'[]'); state.history.forEach(m=>renderMsg(m.content,m.role)); }
  function saveHistory(){ localStorage.setItem(key(), JSON.stringify(state.history.slice(-50))); }

  askBtn.addEventListener('click', async ()=>{
    if(!state.age){ alert('연령대를 선택하세요.'); return; }
    const selected=getCheckedQuestions();
    const userMessage=customEl.value.trim();
    if(selected.length===0 && !userMessage){ alert('질문을 선택하거나 입력하세요.'); return; }

    const promptView = [selected.length? `Q: ${selected.join(' | ')}`:'', userMessage?`Q: ${userMessage}`:''].filter(Boolean).join('\n');
    renderMsg(promptView,'user');
    askBtn.disabled=true;
    try{
      const body = JSON.stringify({ age: state.age, selectedQuestions: selected, userMessage, history: state.history, model:'gpt-4o-mini' });
      // 사전검사 회피: Content-Type 헤더 미설정
      const res = await fetch(APPS_SCRIPT_URL, { method:'POST', body });
      const text = await res.text();
      let data; try{ data = JSON.parse(text); } catch { throw new Error(text); }
      if(data.error) throw new Error(data.error);
      renderMsg(data.reply||'','assistant');
      state.history.push({ role:'user', content: promptView });
      state.history.push({ role:'assistant', content: data.reply||'' });
      saveHistory();
    }catch(err){
      renderMsg(`[오류] ${err.message}`,'assistant');
    }finally{
      askBtn.disabled=false; customEl.value='';
    }
  });

  clearBtn.addEventListener('click', ()=>{ state.history=[]; saveHistory(); loadHistory(); });

  function renderMsg(text, role){
    const div=document.createElement('div'); div.className='msg '+(role==='user'?'user':'ai'); div.textContent=text;
    chatEl.appendChild(div); chatEl.scrollTop=chatEl.scrollHeight;
  }
    function renderCheckboxes(list){
      if(!list.length){
        qbox.innerHTML='<div class="muted">해당 연령대의 추천 질문이 없습니다.</div>';
        return;
      }
      qbox.innerHTML = list.map(q=>{
        return `<label class="qitem"><input type="checkbox" value="${q.text}"><span>${q.text}</span></label>`;
      }).join('');
    }
    
</script>
</body>
</html>
